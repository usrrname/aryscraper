# This is a basic workflow to help you get started with Actions
name: Scrape images and Publish on S3

# Controls when the workflow will run
on: workflow_dispatch

jobs:
  setup:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.9]
    timeout-minutes: 30
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v3
        with:
          python-version: "3.9"
          cache: "pip"
          cache-dependency-path: "**/requirements.txt"
      - run: |
          pip install --upgrade pip && pip install -r requirements.txt
          python3 -m pytest

  build:
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - run: python3 main.py
      - name: archive scraped data
        uses: actions/upload-artifact@v3
        with:
          name: data-set
          path: data-set/**
          retention-days: 5

  publish:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v2
      - uses: keithweaver/aws-s3-github-action@main
        name: sync folder
        with:
          command: cp
          source: ./data-set/
          destination: ${{ secrets.S3_BUCKET }}/data-set
          aws_access_key_id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws_secret_access_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws_region: "canada-central-1"
          flags: --recursive --debug
      - name: Commit changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .
          git diff-index --quiet HEAD || git commit -m "{commit message}" -a
          git push origin main:main
